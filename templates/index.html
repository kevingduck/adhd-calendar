<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Scheduler</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 50;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>

<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <!-- Welcome Section -->
        <div class="mb-8">
            <div class="bg-white rounded-lg shadow p-6">
                <h1 class="text-3xl font-bold text-blue-600 mb-4">MegaTask</h1>
                <div class="grid md:grid-cols-2 gap-4">
                    <div class="space-y-2">
                        <h3 class="font-semibold text-lg">Creating Tasks</h3>
                        <ul class="list-disc list-inside text-gray-600">
                            <li>Enter your task in the input field below</li>
                            <li>MegaTask will suggest steps and time estimates</li>
                            <li>Adjust duration, date, and time as needed</li>
                            <li>Review and confirm the schedule</li>
                        </ul>
                    </div>
                    <div class="space-y-2">
                        <h3 class="font-semibold text-lg">Calendar Integration</h3>
                        <ul class="list-disc list-inside text-gray-600">
                            <li>Add directly to Google Calendar</li>
                            <li>Download as .ics file for other calendars</li>
                            <li>Send email invites to team members</li>
                            <li>Edit or delete tasks anytime</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <!-- Task Input -->
        <div class="mb-8">
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-xl font-bold mb-4">Add New Task</h2>
                <div class="flex gap-2">
                    <input type="text" id="taskInput"
                        class="flex-1 border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="Enter your task...">
                    <button onclick="handleAddTask()"
                        class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        Add
                    </button>
                </div>
            </div>
        </div>

        <!-- Task List -->
        <!-- Update the Task List section in your HTML -->
        <div class="bg-white rounded-lg shadow overflow-x-auto">
            <div class="p-4">
                <h2 class="text-xl font-bold mb-4">Task List</h2>
                <ul id="taskList" class="space-y-4">
                    {% for task in tasks %}
                    <li class="p-4 bg-gray-50 rounded-lg shadow group" data-task-id="{{ task.id }}">
                        <div class="flex justify-between items-start">
                            <div class="flex-grow">
                                <h3 class="font-bold text-lg">{{ task.title }}</h3>
                                <p class="text-gray-600">{{ task.start }} - {{ task.end }}</p>
                                <ul class="list-disc list-inside text-gray-700 mt-2">
                                    {% for step in task.steps %}
                                    <li>{{ step }}</li>
                                    {% endfor %}
                                </ul>
                            </div>
                            <div class="flex items-center space-x-2">
                                <!-- Calendar Actions -->
                                <div class="flex space-x-1">
                                    <button onclick="addToGoogleCalendarFromList(this)" title="Add to Google Calendar"
                                        class="text-gray-500 hover:text-red-500 p-1">
                                        <i class="fab fa-google"></i>
                                    </button>
                                    <button onclick="downloadICSFromList(this)" title="Download Calendar File"
                                        class="text-gray-500 hover:text-gray-700 p-1">
                                        <i class="far fa-calendar-alt"></i>
                                    </button>
                                    <button onclick="sendEmailInviteFromList(this)" title="Send Email Invite"
                                        class="text-gray-500 hover:text-blue-500 p-1">
                                        <i class="far fa-envelope"></i>
                                    </button>
                                </div>
                                <!-- CRUD Actions -->
                                <div class="flex space-x-1 ml-2 border-l pl-2">
                                    <button onclick="editTask(this)" title="Edit Task"
                                        class="text-gray-500 hover:text-blue-500 p-1">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button onclick="deleteTask(this)" title="Delete Task"
                                        class="text-gray-500 hover:text-red-500 p-1">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>

        <!-- Add Edit Task Modal -->
        <div id="editTaskModal" class="modal">
            <div class="bg-white rounded-lg shadow-lg max-w-xl w-full mx-4">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold">Edit Task</h3>
                        <button onclick="closeModal('editTaskModal')" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>

                    <div class="space-y-4">
                        <input type="hidden" id="editTaskId">
                        <!-- Task Title -->
                        <div>
                            <label class="block text-sm font-medium mb-1">Task Title</label>
                            <input type="text" id="editTaskTitle" class="w-full px-3 py-2 border rounded-lg">
                        </div>

                        <!-- Time Settings -->
                        <div class="grid grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-1">Duration (hours)</label>
                                <input type="number" id="editModalDuration" min="0.5" step="0.5"
                                    class="w-full px-3 py-2 border rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Date</label>
                                <input type="date" id="editModalDate" class="w-full px-3 py-2 border rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Time</label>
                                <input type="time" id="editModalTime" class="w-full px-3 py-2 border rounded-lg">
                            </div>
                        </div>

                        <!-- Steps -->
                        <div>
                            <label class="block text-sm font-medium mb-1">Steps</label>
                            <div id="editStepsContainer" class="space-y-2">
                                <!-- Steps will be added here dynamically -->
                            </div>
                            <button onclick="addStepInput()" class="mt-2 text-blue-500 hover:text-blue-600">
                                <i class="fas fa-plus"></i> Add Step
                            </button>
                        </div>
                    </div>

                    <!-- Buttons -->
                    <div class="mt-6 flex justify-end gap-3">
                        <button onclick="closeModal('editTaskModal')"
                            class="px-4 py-2 border rounded-lg hover:bg-gray-50">
                            Cancel
                        </button>
                        <button onclick="saveTaskEdit()"
                            class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                            Save Changes
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Task Creation Modal -->
    <div id="taskModal" class="modal">
        <div class="bg-white rounded-lg shadow-lg max-w-xl w-full mx-4">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold">Confirm Task Schedule</h3>
                    <button onclick="closeModal('taskModal')" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div class="space-y-4">
                    <!-- Task Details -->
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h4 class="font-semibold mb-2">Task</h4>
                        <p id="modalTaskTitle" class="text-gray-700"></p>
                    </div>

                    <!-- Time Settings -->
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Duration (hours)</label>
                            <input type="number" id="modalDuration" min="0.5" step="0.5"
                                class="w-full px-3 py-2 border rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Date</label>
                            <input type="date" id="modalDate" class="w-full px-3 py-2 border rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Time</label>
                            <input type="time" id="modalTime" class="w-full px-3 py-2 border rounded-lg" min="09:00"
                                max="17:00">
                        </div>
                    </div>

                    <!-- Steps -->
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h4 class="font-semibold mb-2">Suggested Steps</h4>
                        <ul id="modalSteps" class="list-disc list-inside space-y-1 text-gray-700">
                        </ul>
                    </div>
                </div>

                <!-- Calendar Integration and Buttons -->
                <div class="mt-6 space-y-4">
                    <!-- Calendar Integration -->
                    <div class="flex flex-wrap gap-3 justify-center">
                        <button onclick="addToGoogleCalendar()"
                            class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 flex items-center">
                            <i class="fab fa-google mr-2"></i>Add to Google Calendar
                        </button>
                        <button onclick="downloadICS()"
                            class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 flex items-center">
                            <i class="far fa-calendar-alt mr-2"></i>Download for Calendar
                        </button>
                        <button onclick="sendEmailInvite()"
                            class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 flex items-center">
                            <i class="far fa-envelope mr-2"></i>Email Invite
                        </button>
                    </div>

                    <!-- Original Modal Buttons -->
                    <div class="flex justify-end gap-3">
                        <button onclick="closeModal('taskModal')" class="px-4 py-2 border rounded-lg hover:bg-gray-50">
                            Cancel
                        </button>
                        <button onclick="confirmTask()"
                            class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">
                            Schedule Task
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize variables in global scope
        let currentTask = "";
        let currentEstimate = null;

        // Helper Functions
        function generateICS(task, startTime, endTime, steps) {
            const formatDateTime = (date) => {
                return date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
            };

            const start = formatDateTime(new Date(startTime));
            const end = formatDateTime(new Date(endTime));
            const description = steps.map(step => `- ${step}`).join('\\n');

            return `BEGIN:VCALENDAR
VERSION:2.0
BEGIN:VEVENT
DTSTART:${start}
DTEND:${end}
SUMMARY:${task}
DESCRIPTION:${description}
END:VEVENT
END:VCALENDAR`;
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.remove('active');
        }

        // Task Creation Functions
        async function handleAddTask() {
            const taskInput = document.getElementById('taskInput');
            const task = taskInput.value.trim();

            if (!task) {
                alert('Please enter a task');
                return;
            }

            const addButton = document.querySelector('button[onclick="handleAddTask()"]');
            const originalButtonText = addButton.innerHTML;
            addButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Getting estimate...';
            addButton.disabled = true;

            try {
                const response = await fetch('/get_estimate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ task })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to get estimate');
                }

                if (!data || typeof data.hours === 'undefined' || !Array.isArray(data.steps)) {
                    throw new Error('Invalid estimate received');
                }

                currentTask = task;
                currentEstimate = data;
                showTaskModal(task, data);
                taskInput.value = '';

            } catch (error) {
                console.error('Error:', error);
                alert(error.message || 'Failed to get task estimate. Please try again.');
            } finally {
                addButton.innerHTML = originalButtonText;
                addButton.disabled = false;
            }
        }

        function showTaskModal(task, estimate) {
            if (!task || !estimate) {
                console.error('Invalid inputs to showTaskModal:', { task, estimate });
                return;
            }

            const modal = document.getElementById('taskModal');
            const taskTitle = document.getElementById('modalTaskTitle');
            const duration = document.getElementById('modalDuration');
            const date = document.getElementById('modalDate');
            const time = document.getElementById('modalTime');
            const steps = document.getElementById('modalSteps');

            const today = new Date().toISOString().split('T')[0];
            date.value = today;

            const nextHour = new Date();
            nextHour.setHours(nextHour.getHours() + 1, 0, 0, 0);
            time.value = nextHour.toTimeString().slice(0, 5);

            taskTitle.textContent = task;
            duration.value = estimate.hours;

            steps.innerHTML = '';
            if (Array.isArray(estimate.steps)) {
                estimate.steps.forEach(step => {
                    const li = document.createElement('li');
                    li.textContent = step;
                    steps.appendChild(li);
                });
            }

            modal.classList.add('active');
        }

        async function confirmTask() {
            const duration = document.getElementById('modalDuration').value;
            const date = document.getElementById('modalDate').value;
            const time = document.getElementById('modalTime').value;

            if (!duration || !date || !time) {
                alert("Please fill in all fields.");
                return;
            }

            try {
                const response = await fetch('/add_task', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        task: currentTask,
                        duration: duration,
                        date: date,
                        time: time,
                        steps: currentEstimate.steps
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    alert(error.error);
                    return;
                }

                closeModal('taskModal');
                location.reload();

            } catch (error) {
                console.error('Error:', error);
                alert('Failed to schedule task');
            }
        }

        // Calendar Functions for New Tasks
        function addToGoogleCalendar() {
            const task = document.getElementById('modalTaskTitle').textContent;
            const date = document.getElementById('modalDate').value;
            const time = document.getElementById('modalTime').value;
            const duration = document.getElementById('modalDuration').value;
            const steps = Array.from(document.getElementById('modalSteps').children)
                .map(li => li.textContent);

            const startDateTime = new Date(`${date}T${time}`);
            const endDateTime = new Date(startDateTime.getTime() + (duration * 60 * 60 * 1000));

            const startFormatted = startDateTime.toISOString().replace(/[:-]/g, '').replace(/\.\d{3}/, '');
            const endFormatted = endDateTime.toISOString().replace(/[:-]/g, '').replace(/\.\d{3}/, '');

            const url = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(task)}&dates=${startFormatted}/${endFormatted}&details=${encodeURIComponent(steps.join('\n'))}`;

            window.open(url, '_blank');
        }

        function downloadICS() {
            const task = document.getElementById('modalTaskTitle').textContent;
            const date = document.getElementById('modalDate').value;
            const time = document.getElementById('modalTime').value;
            const duration = document.getElementById('modalDuration').value;

            const startDateTime = new Date(`${date}T${time}`);
            const endDateTime = new Date(startDateTime.getTime() + (duration * 60 * 60 * 1000));
            const steps = Array.from(document.getElementById('modalSteps').children)
                .map(li => li.textContent);

            const icsContent = generateICS(task, startDateTime, endDateTime, steps);

            const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
            const link = document.createElement('a');
            link.href = window.URL.createObjectURL(blob);
            link.download = `${task.substring(0, 30)}.ics`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function sendEmailInvite() {
            const task = document.getElementById('modalTaskTitle').textContent;
            const date = document.getElementById('modalDate').value;
            const time = document.getElementById('modalTime').value;
            const duration = document.getElementById('modalDuration').value;

            const startDateTime = new Date(`${date}T${time}`);
            const dateStr = startDateTime.toLocaleDateString();
            const timeStr = startDateTime.toLocaleTimeString();

            const steps = Array.from(document.getElementById('modalSteps').children)
                .map(li => li.textContent)
                .join('\n');

            const subject = encodeURIComponent(`Task: ${task}`);
            const body = encodeURIComponent(
                `Task: ${task}\n` +
                `Date: ${dateStr}\n` +
                `Time: ${timeStr}\n` +
                `Duration: ${duration} hours\n\n` +
                `Steps:\n${steps}`
            );

            window.location.href = `mailto:?subject=${subject}&body=${body}`;
        }

        // Edit Task Functions
        function editTask(button) {
            const taskItem = button.closest('li');
            const taskId = taskItem.dataset.taskId;
            const title = taskItem.querySelector('h3').textContent;
            const timeRange = taskItem.querySelector('p').textContent;
            const steps = Array.from(taskItem.querySelectorAll('ul.list-disc li')).map(li => li.textContent);

            const [startStr, endStr] = timeRange.split(' - ');
            const start = new Date(startStr);
            const end = new Date(endStr);
            const duration = (end - start) / (1000 * 60 * 60);

            document.getElementById('editTaskId').value = taskId;
            document.getElementById('editTaskTitle').value = title;
            document.getElementById('editModalDuration').value = duration;
            document.getElementById('editModalDate').value = start.toISOString().split('T')[0];
            document.getElementById('editModalTime').value = start.toTimeString().slice(0, 5);

            const stepsContainer = document.getElementById('editStepsContainer');
            stepsContainer.innerHTML = '';
            steps.forEach(step => {
                const stepDiv = document.createElement('div');
                stepDiv.className = 'flex gap-2';
                stepDiv.innerHTML = `
            <input type="text" value="${step}" class="flex-grow px-3 py-2 border rounded-lg">
            <button onclick="this.parentElement.remove()" class="text-red-500 hover:text-red-700">
                <i class="fas fa-times"></i>
            </button>
        `;
                stepsContainer.appendChild(stepDiv);
            });

            document.getElementById('editTaskModal').classList.add('active');
        }

        function addStepInput() {
            const stepDiv = document.createElement('div');
            stepDiv.className = 'flex gap-2';
            stepDiv.innerHTML = `
        <input type="text" class="flex-grow px-3 py-2 border rounded-lg" placeholder="Enter step...">
        <button onclick="this.parentElement.remove()" class="text-red-500 hover:text-red-700">
            <i class="fas fa-times"></i>
        </button>
    `;
            document.getElementById('editStepsContainer').appendChild(stepDiv);
        }

        async function saveTaskEdit() {
            const taskId = document.getElementById('editTaskId').value;
            const title = document.getElementById('editTaskTitle').value;
            const duration = document.getElementById('editModalDuration').value;
            const date = document.getElementById('editModalDate').value;
            const time = document.getElementById('editModalTime').value;

            const steps = Array.from(document.getElementById('editStepsContainer').children)
                .map(div => div.querySelector('input').value)
                .filter(step => step.trim() !== '');

            try {
                const response = await fetch(`/update_task/${taskId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        task: title,
                        duration: duration,
                        date: date,
                        time: time,
                        steps: steps
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to update task');
                }

                location.reload();

            } catch (error) {
                console.error('Error:', error);
                alert(error.message || 'Failed to update task');
            }
        }

        async function deleteTask(button) {
            if (!confirm('Are you sure you want to delete this task?')) {
                return;
            }

            const taskItem = button.closest('li');
            const taskId = taskItem.dataset.taskId;

            try {
                const response = await fetch(`/delete_task/${taskId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to delete task');
                }

                taskItem.remove();

            } catch (error) {
                console.error('Error:', error);
                alert(error.message || 'Failed to delete task');
            }
        }

        // Calendar Functions for List Items
        function addToGoogleCalendarFromList(button) {
            const taskItem = button.closest('li');
            const title = taskItem.querySelector('h3').textContent;
            const timeRange = taskItem.querySelector('p').textContent;
            const steps = Array.from(taskItem.querySelectorAll('ul.list-disc li')).map(li => li.textContent);

            const [startTimeStr, endTimeStr] = timeRange.split(' - ');
            const startDate = new Date(startTimeStr);
            const endDate = new Date(endTimeStr);

            const startFormatted = startDate.toISOString().replace(/[:-]/g, '').replace(/\.\d{3}/, '');
            const endFormatted = endDate.toISOString().replace(/[:-]/g, '').replace(/\.\d{3}/, '');

            const url = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(title)}&dates=${startFormatted}/${endFormatted}&details=${encodeURIComponent(steps.join('\n'))}`;

            window.open(url, '_blank');
        }

        function downloadICSFromList(button) {
            const taskItem = button.closest('li');
            const title = taskItem.querySelector('h3').textContent;
            const timeRange = taskItem.querySelector('p').textContent;
            const steps = Array.from(taskItem.querySelectorAll('ul.list-disc li')).map(li => li.textContent);

            const [startTimeStr, endTimeStr] = timeRange.split(' - ');
            const startDate = new Date(startTimeStr);
            const endDate = new Date(endTimeStr);

            const icsContent = generateICS(title, startDate, endDate, steps);

            const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
            const link = document.createElement('a');
            link.href = window.URL.createObjectURL(blob);
            link.download = `${title.substring(0, 30)}.ics`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function sendEmailInviteFromList(button) {
            const taskItem = button.closest('li');
            const title = taskItem.querySelector('h3').textContent;
            const timeRange = taskItem.querySelector('p').textContent;
            const steps = Array.from(taskItem.querySelectorAll('ul.list-disc li')).map(li => li.textContent);

            const [startTimeStr, endTimeStr] = timeRange.split(' - ');
            const startDate = new Date(startTimeStr);
            const duration = (new Date(endTimeStr) - startDate) / (1000 * 60 * 60);

            const dateStr = startDate.toLocaleDateString();
            const timeStr = startDate.toLocaleTimeString();

            const subject = encodeURIComponent(`Task: ${title}`);
            const body = encodeURIComponent(
                `Task: ${title}\n` +
                `Date: ${dateStr}\n` +
                `Time: ${timeStr}\n` +
                `Duration: ${duration} hours\n\n` +
                `Steps:\n${steps.join('\n')}`
            );

            window.location.href = `mailto:?subject=${subject}&body=${body}`;
        }

        // Add event listener for enter key on task input
        document.getElementById('taskInput').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                handleAddTask();
            }
        });
    </script>

</body>

</html>